<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>神奇故事 - 创意魔法世界</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/responsive-base.css">
  <style>
        /* Basic styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: "微软雅黑", Arial, sans-serif;
            background-color: #F9F7FF;
            color: #333;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .container {
            width: var(--container-width);
            margin: 0 auto;
            padding: var(--spacing-md);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            height: auto;
            overflow-x: hidden;
        }
        
        /* Top navigation */
        .top-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
        }
        
        .home-btn {
            width: var(--btn-size-md);
            height: var(--btn-size-md);
            background-color: #E3F2FD;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            box-shadow: 0 4px 10px rgba(33, 150, 243, 0.3);
            border: 3px solid #2196F3;
            transition: all 0.3s;
        }
        
        .home-btn:hover {
            transform: scale(1.1);
        }
        
        .home-btn i {
            font-size: var(--icon-size-md);
            color: #2196F3;
        }
        
        .page-title {
            font-size: var(--font-size-xl);
            color: #2196F3;
            font-weight: bold;
            text-align: center;
            flex-grow: 1;
            margin-left: var(--spacing-md);
        }
        
        /* Main content area */
        .main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-bottom: var(--spacing-md);
            position: relative;
        }
        
        /* Generation options */
        .generation-options {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-md);
            margin-top: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }
        
        .option-group {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .option-group label {
            margin-bottom: var(--spacing-xs);
            font-weight: bold;
            color: #666;
        }
        
        /* Prompt display */
        .prompt-display {
            background-color: #f0f0f0;
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: 10px;
            margin-bottom: var(--spacing-md);
            font-size: var(--font-size-sm);
            max-width: 90%;
            text-align: center;
            display: none;
        }
        
        /* Story preview area */
        .story-preview {
            width: 96%;
            max-width: 800px;
            height: var(--preview-height);
            min-height: 300px;
            background-color: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
            border: 5px dashed #90CAF9;
            margin-bottom: var(--spacing-lg);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .empty-prompt {
            text-align: center;
            padding: var(--spacing-md);
        }
        
        .empty-prompt img {
            width: clamp(80px, 25vw, 120px);
            height: clamp(80px, 25vw, 120px);
            margin-bottom: var(--spacing-md);
        }
        
        .empty-prompt .prompt-text {
            font-size: var(--font-size-md);
            color: #999;
            font-weight: bold;
        }
        
        /* Story content */
        .story-content {
            width: 100%;
            height: 100%;
            padding: var(--spacing-md);
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .story-title {
            font-size: var(--font-size-xl);
            color: #2196F3;
            margin-bottom: var(--spacing-md);
            text-align: center;
            width: 100%;
        }
        
        .story-page {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            width: 100%;
            flex-grow: 1;
            position: relative;
            padding-bottom: 30px; /* Space for page indicator */
        }
        
        /* 响应式布局 - 大屏幕时并排显示图片和文本 */
        @media (min-width: var(--breakpoint-md)) {
            .story-page {
                flex-direction: row;
                align-items: center;
                justify-content: center;
                padding: 0 var(--spacing-md) 30px var(--spacing-md);
                gap: var(--spacing-lg);
            }
            
            .page-image-container {
                width: 55%;
                display: flex;
                justify-content: center;
                align-items: center;
                max-height: 45vh;
            }
            
            .page-text-container {
                width: 40%;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                background-color: rgba(255, 255, 255, 0.8);
                padding: var(--spacing-md);
                border-radius: 15px;
                box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            }
        }
        
        /* 小屏幕是垂直布局 */
        @media (max-width: var(--breakpoint-md)) {
            .page-image-container {
                width: 90%;
                display: flex;
                justify-content: center;
                align-items: center;
                margin-bottom: var(--spacing-md);
            }
            
            .page-text-container {
                width: 90%;
                background-color: rgba(255, 255, 255, 0.8);
                padding: var(--spacing-sm);
                border-radius: 15px;
                box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            }
        }
        
        .page-image {
            max-width: 100%;
            max-height: 45vh;
            object-fit: contain;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: var(--spacing-md);
        }
        
        @media (min-width: var(--breakpoint-md)) {
            .page-image {
                margin-bottom: 0;
            }
        }
        
        .page-text {
            font-size: var(--font-size-lg);
            line-height: 1.5;
            text-align: center;
            margin-top: var(--spacing-md);
            font-weight: 500;
        }
        
        /* Character highlighting */
        .character-span {
            display: inline-block;
            transition: all 0.2s ease;
        }
        
        .character-span.active {
            color: #FF4D4D;
            font-weight: bold;
            transform: scale(1.2);
            position: relative;
        }
        
        .character-span.active::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 8px;
            height: 8px;
            background-color: #FF5722;
            border-radius: 50%;
            animation: pulse 1s infinite;
        }
        
        .page-indicator {
            position: absolute;
            bottom: 5px;
            left: 50%;
            transform: translateX(-50%);
            font-size: var(--font-size-xs);
            color: #777;
            background-color: rgba(255, 255, 255, 0.7);
            padding: 3px 10px;
            border-radius: 10px;
        }
        
        /* Page navigation */
        .page-navigation {
            display: flex;
            justify-content: space-between;
            width: 100%;
            padding: 0 var(--spacing-lg);
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            z-index: 10;
        }
        
        .nav-btn {
            width: clamp(30px, 8vw, 40px);
            height: clamp(30px, 8vw, 40px);
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            pointer-events: auto;
        }
        
        .nav-btn:hover {
            background-color: #2196F3;
            color: white;
        }
        
        .nav-btn i {
            font-size: var(--icon-size-sm);
        }
        
        /* Control buttons */
        .control-area {
            display: flex;
            justify-content: center;
            gap: clamp(10px, 4vw, 30px);
            flex-wrap: wrap;
        }
        
        .voice-btn, .generate-btn, .refresh-btn, .speech-btn {
            width: var(--btn-size-md);
            height: var(--btn-size-md);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 4px solid white;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }
        
        .voice-btn {
            background: linear-gradient(145deg, #FF6B6B, #FF9D80);
        }
        
        .generate-btn {
            background: linear-gradient(145deg, #42A5F5, #2196F3);
        }
        
        .refresh-btn {
            background: linear-gradient(145deg, #4CD964, #3CB371);
        }
        
        .speech-btn {
            background: linear-gradient(145deg, #9C27B0, #673AB7);
        }
        
        .voice-btn:hover, .generate-btn:hover, .refresh-btn:hover, .speech-btn:hover {
            transform: scale(1.1);
        }
        
        .voice-btn i, .generate-btn i, .refresh-btn i, .speech-btn i {
            font-size: var(--icon-size-md);
            color: white;
        }
        
        /* Loading animation */
        .loading-animation {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .loading-spinner {
            width: clamp(60px, 15vw, 80px);
            height: clamp(60px, 15vw, 80px);
            border-radius: 50%;
            border: 8px solid #f3f3f3;
            border-top: 8px solid #2196F3;
            animation: spin 1s linear infinite;
            margin-bottom: var(--spacing-md);
        }
        
        .loading-text {
            font-size: var(--font-size-lg);
            color: #666;
            font-weight: bold;
        }
        
        /* Feedback overlay */
        .feedback-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .feedback-modal {
            background-color: white;
            padding: clamp(20px, 5vw, 40px);
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
            max-width: 90%;
            width: fit-content;
        }
        
        .feedback-icon {
            font-size: var(--icon-size-lg);
            color: #2196F3;
            margin-bottom: var(--spacing-md);
            animation: pulse 1.5s infinite;
        }
        
        .feedback-text {
            font-size: var(--font-size-lg);
            font-weight: bold;
            color: #333;
        }
        
        /* Cloud decorations */
        .cloud {
            position: absolute;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            z-index: -1;
        }
        
        .cloud1 {
            width: 200px;
            height: 60px;
            top: 100px;
            left: -100px;
            animation: floatCloud 20s linear infinite;
        }
        
        .cloud2 {
            width: 150px;
            height: 45px;
            top: 300px;
            right: -50px;
            animation: floatCloud 15s linear infinite;
            animation-delay: 2s;
        }
        
        /* Animations */
        @keyframes pulse {
            0% {
                transform: translateX(-50%) scale(0.8);
                opacity: 0.7;
            }
            50% {
                transform: translateX(-50%) scale(1.2);
                opacity: 1;
            }
            100% {
                transform: translateX(-50%) scale(0.8);
                opacity: 0.7;
            }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes floatCloud {
            0% {
                transform: translateX(0);
            }
            100% {
                transform: translateX(calc(100vw + 200px));
            }
        }
        
        @keyframes fadeIn {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }
        
        /* 深色模式支持 */
        @media (prefers-color-scheme: dark) {
            body {
                background-color: #232333;
                color: #f0f0f0;
            }
            
            .story-preview {
                background-color: #2a2a3a;
                border-color: #64B5F6;
            }
            
            .page-text-container {
                background-color: rgba(42, 42, 58, 0.8);
            }
            
            .page-text {
                color: #f0f0f0;
            }
            
            .empty-prompt .prompt-text {
                color: #bbbbbb;
            }
            
            .prompt-display {
                background-color: #333344;
                color: #f0f0f0;
            }
            
            .feedback-modal {
                background-color: #2a2a3a;
            }
            
            .feedback-text {
                color: #f0f0f0;
            }
            
            .loading-animation {
                background-color: rgba(40, 40, 50, 0.9);
            }
            
            .loading-text {
                color: #dddddd;
            }
        }
        
        /* Speed bookmark styles */
        .speed-bookmark-container {
            position: absolute;
            right: 0;
            top: 180px;
            z-index: 10;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .speed-toggle {
            display: flex;
            flex-direction: column;
            background-color: #f8f8f8;
            border-radius: 0 10px 10px 0;
            overflow: hidden;
            border: 2px solid #90CAF9;
            border-left-width: 0;
            box-shadow: 3px 3px 8px rgba(0, 0, 0, 0.2);
            width: 36px;
        }
        
        .speed-option {
            padding: 16px 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            writing-mode: vertical-rl;
            font-weight: bold;
            color: #666;
        }
        
        .speed-option.active {
            background-color: #2196F3;
            color: white;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.2);
        }
        
        /* 超小屏幕的特殊处理 */
        @media (max-width: var(--breakpoint-xs)) {
            .story-preview {
                height: 65vh;
                min-height: 300px;
            }
            
            .page-image {
                max-height: 35vh;
            }
            
            .page-text {
                font-size: var(--font-size-md);
            }
            
            .character-span.active::after {
                width: 6px;
                height: 6px;
                bottom: -5px;
            }
            
            .home-btn, .voice-btn, .generate-btn, .refresh-btn, .speech-btn {
                width: var(--btn-size-sm);
                height: var(--btn-size-sm);
            }
            
            .control-area {
                gap: var(--spacing-sm);
            }
        }
    </style>
</head>
<body>
    <!-- Decorative clouds -->
    <div class="cloud cloud1"></div>
    <div class="cloud cloud2"></div>
    
    <div class="container">
        <!-- Top navigation -->
        <div class="top-nav">
            <a href="kids-homepage.html" class="home-btn" title="返回首页">
                <i class="fas fa-home"></i>
            </a>
            <div class="page-title">神奇故事</div>
            <div style="width: 70px;"></div><!-- Placeholder for centering -->
      </div>
      
        <!-- Main content area -->
        <div class="main-content">
            <!-- Prompt display area -->
            <div class="prompt-display" id="promptDisplay"></div>
            
            <!-- Speed bookmark container -->
            <div class="speed-bookmark-container">
                <div class="speed-toggle">
                    <span class="speed-option active" id="speedFast">快</span>
                    <span class="speed-option" id="speedSlow">慢</span>
                </div>
            </div>
            
            <!-- Generation options -->
            <div class="generation-options">
                <div class="option-group" style="display: none;">
                    <label>故事页数:</label>
                    <select id="pageCountSelect">
                        <option value="3">3页</option>
                        <option value="5" selected>5页</option>
                        <option value="8">8页</option>
                        <option value="10">10页</option>
                    </select>
                </div>
            </div>
            
            <!-- Story preview area -->
            <div class="story-preview" id="storyPreview">
                <div class="empty-prompt" id="emptyPrompt">
                    <img src="https://cdn-icons-png.flaticon.com/512/3163/3163478.png" alt="故事提示">
                    <div class="prompt-text">点击下方麦克风，说出你想要的故事主题</div>
    </div>
    
                <!-- Story content (initially hidden) -->
                <div class="story-content" id="storyContent" style="display: none;">
                    <h2 class="story-title" id="storyTitle">故事标题</h2>
                    <div class="story-page">
                        <div class="page-image-container">
                            <img id="pageImage" src="" class="page-image" alt="故事插图">
                        </div>
                        <div class="page-text-container">
                            <p id="pageText" class="page-text"></p>
                        </div>
                        <div id="pageIndicator" class="page-indicator">1 / 5</div>
    </div>
    
                    <!-- Page navigation -->
                    <div class="page-navigation">
                        <div class="nav-btn" id="prevBtn">
                            <i class="fas fa-chevron-left"></i>
                        </div>
                        <div class="nav-btn" id="nextBtn">
                            <i class="fas fa-chevron-right"></i>
                        </div>
        </div>
      </div>
      
                <!-- Loading animation -->
                <div class="loading-animation" id="loadingAnimation" style="display: none;">
                    <div class="loading-spinner"></div>
                    <div class="loading-text" id="loadingText">正在生成故事...</div>
                </div>
        </div>
        
            <!-- Control buttons -->
            <div class="control-area">
                <div class="voice-btn" id="voiceBtn" title="说出故事主题">
                    <i class="fas fa-microphone"></i>
        </div>
                <div class="generate-btn" id="generateBtn" title="生成故事">
                    <i class="fas fa-magic"></i>
                </div>
                <div class="refresh-btn" id="refreshBtn" title="重新生成" style="opacity: 0.6; pointer-events: none;">
                    <i class="fas fa-sync-alt"></i>
                </div>
                <div class="speech-btn" id="speechBtn" title="朗读故事" style="opacity: 0.6; pointer-events: none;">
                    <i class="fas fa-volume-up"></i>
                </div>
            </div>
      </div>
    </div>
    
    <!-- Voice feedback overlay -->
    <div class="feedback-overlay" id="feedbackOverlay" style="display: none;">
        <div class="feedback-modal">
            <i class="fas fa-volume-up feedback-icon" id="feedbackIcon"></i>
            <div class="feedback-text" id="feedbackText">我在听...</div>
    </div>
  </div>

  <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Hardcoded API keys (hidden from users)
            const GLM_API_KEY = "244f140877ca48249bd479ffe90dbe4e.LBEDyVXHIuRp7lsR";
            const ZETATECHS_API_KEY = "sk-V60xqPUesdrbZMxfsYy3lJSpfF8g8ewnUDGilq72BE0iyZpg";
            
            // API endpoints
    const GLM_API_URL = 'https://open.bigmodel.cn/api/paas/v4';
    const ZETATECHS_API_URL = 'https://api.zetatechs.com/v1';
    
            // DOM Elements
            const voiceBtn = document.getElementById('voiceBtn');
    const generateBtn = document.getElementById('generateBtn');
            const refreshBtn = document.getElementById('refreshBtn');
            const speechBtn = document.getElementById('speechBtn');
            const feedbackOverlay = document.getElementById('feedbackOverlay');
            const feedbackIcon = document.getElementById('feedbackIcon');
            const feedbackText = document.getElementById('feedbackText');
            const storyPreview = document.getElementById('storyPreview');
            const emptyPrompt = document.getElementById('emptyPrompt');
            const storyContent = document.getElementById('storyContent');
            const loadingAnimation = document.getElementById('loadingAnimation');
    const pageImage = document.getElementById('pageImage');
    const pageText = document.getElementById('pageText');
    const pageIndicator = document.getElementById('pageIndicator');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
            const promptDisplay = document.getElementById('promptDisplay');
            const storyTitle = document.getElementById('storyTitle');
            const speedFast = document.getElementById('speedFast');
            const speedSlow = document.getElementById('speedSlow');
            const pageCountSelect = document.getElementById('pageCountSelect');
            const loadingText = document.getElementById('loadingText');
            
            // State variables
            let storyPages = null;
            let currentPage = 0;
            let isReading = false;
            let speechSynthesisUtterance = null;
            let currentTopic = '';
            let useGlmApi = true; // Default to fast mode (GLM API)
            let isGenerating = false;
            let isListening = false; // 添加语音识别状态变量
            
            // Initialize speech recognition
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            let recognition;
            
            if (SpeechRecognition) {
                recognition = new SpeechRecognition();
                recognition.continuous = true; // 设置为持续模式，不会自动停止
                recognition.lang = 'zh-CN';
                recognition.interimResults = false;
                recognition.maxAlternatives = 1;
                
                recognition.onstart = function() {
                    showFeedback('我在听...', 'fa-volume-up');
                    voiceBtn.style.boxShadow = '0 0 15px #FF6B6B';
                    isListening = true; // 更新状态
                    voiceBtn.innerHTML = '<i class="fas fa-microphone-slash"></i>'; // 更改图标
                    voiceBtn.title = '点击停止语音输入';
                };
                
                recognition.onresult = function(event) {
                    const lastResultIndex = event.results.length - 1;
                    const transcript = event.results[lastResultIndex][0].transcript;
                    showFeedback(`识别到: ${transcript}`, 'fa-check');
                    
                    // Store recognized topic
                    currentTopic = transcript;
                    
                    // Display the prompt
                    promptDisplay.textContent = `故事主题: "${currentTopic}"`;
                    promptDisplay.style.display = 'block';
                    
                    // 不自动关闭反馈，让用户可以继续说话或手动关闭
                    // 添加可关闭的反馈提示
                    feedbackText.innerHTML = `识别到: "${transcript}"<br><small style="font-size: 14px;">(继续说话或点击停止)</small>`;
                };
                
                recognition.onerror = function(event) {
                    console.error('Speech recognition error', event.error);
                    showFeedback('无法识别，请重试', 'fa-exclamation-circle');
                    
                    setTimeout(() => {
                        if (!isListening) { // 只有在不再监听时才隐藏
                            feedbackOverlay.style.display = 'none';
                        }
                    }, 2000);
                };
                
                recognition.onend = function() {
                    // 只有当用户手动停止时才重置UI
                    if (!isListening) {
                        voiceBtn.style.boxShadow = '';
                        voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                        voiceBtn.title = '说出故事主题';
                        feedbackOverlay.style.display = 'none';
                        
                        // 如果我们有一个主题并且不在生成中，自动开始生成
                        if (currentTopic.trim().length > 0 && !isGenerating) {
                            generateStory();
                        }
                    } else {
                        // 如果仍应该在监听状态，则重新开始识别
                        try {
                            recognition.start();
                        } catch (e) {
                            // 已经在监听，忽略错误
                            console.log('Recognition already started');
                        }
                    }
                };
            } else {
                console.error('Speech recognition not supported');
                // Disable voice button if not supported
                voiceBtn.style.opacity = '0.5';
                voiceBtn.style.pointerEvents = 'none';
                voiceBtn.title = '您的浏览器不支持语音识别';
            }
            
            // Initialize speech synthesis
            function initSpeechSynthesis() {
                if (!window.speechSynthesis) {
                    console.error('Speech synthesis not supported');
                    speechBtn.style.opacity = '0.5';
                    speechBtn.style.pointerEvents = 'none';
                    speechBtn.title = '您的浏览器不支持语音合成';
                    return false;
                }
                
                // Load voices
                window.speechSynthesis.getVoices();
                return true;
            }
            
            // API Selection
            speedFast.addEventListener('click', function() {
                useGlmApi = true;
                speedFast.classList.add('active');
                speedSlow.classList.remove('active');
            });
            
            speedSlow.addEventListener('click', function() {
                useGlmApi = false;
                speedSlow.classList.add('active');
                speedFast.classList.remove('active');
            });
            
            // Voice button click handler
            voiceBtn.addEventListener('click', function() {
                if (recognition && !isGenerating) {
                    if (!isListening) {
                        // 开始语音识别
                        recognition.start();
                    } else {
                        // 停止语音识别
                        isListening = false;
                        recognition.stop();
                        voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                        voiceBtn.title = '说出故事主题';
                        voiceBtn.style.boxShadow = '';
                    }
                }
            });
            
            // Generate button click handler
            generateBtn.addEventListener('click', function() {
                if (!isGenerating) {
                    // If we don't have a topic yet, prompt for one
                    if (!currentTopic || currentTopic.trim().length === 0) {
                        showFeedback('请先说出故事主题', 'fa-microphone');
                        setTimeout(() => {
                            feedbackOverlay.style.display = 'none';
                            
                            // Start voice recognition
                            if (recognition) {
                                recognition.start();
                            }
                        }, 1500);
        return;
      }
      
                    generateStory();
                }
            });
            
            // Refresh button click handler
            refreshBtn.addEventListener('click', function() {
                if (this.style.opacity !== '0.6' && !isGenerating) {
                    generateStory();
                }
            });
            
            // Speech button click handler
            speechBtn.addEventListener('click', function() {
                if (this.style.opacity !== '0.6') {
                    if (isReading) {
                        stopReading();
                        this.innerHTML = '<i class="fas fa-volume-up"></i>';
                        this.title = '朗读故事';
                    } else {
                        startReading();
                        this.innerHTML = '<i class="fas fa-volume-mute"></i>';
                        this.title = '暂停朗读';
                    }
                }
            });
            
            // Previous page button
            prevBtn.addEventListener('click', function() {
                if (currentPage > 0) {
                    showPage(currentPage - 1);
                    
                    // If reading, read the new page
                    if (isReading) {
                        speakCurrentPage();
                    }
                }
            });
            
            // Next page button
            nextBtn.addEventListener('click', function() {
                if (storyPages && currentPage < storyPages.pages.length - 1) {
                    showPage(currentPage + 1);
                    
                    // If reading, read the new page
                    if (isReading) {
                        speakCurrentPage();
                    }
                }
            });
            
            // Generate story function
            async function generateStory() {
                if (isGenerating) return;
                
                isGenerating = true;
                loadingAnimation.style.display = 'flex';
                storyContent.style.display = 'none';
                emptyPrompt.style.display = 'none';
                
                // Disable controls during generation
                voiceBtn.style.opacity = '0.6';
                voiceBtn.style.pointerEvents = 'none';
                generateBtn.style.opacity = '0.6';
                generateBtn.style.pointerEvents = 'none';
                refreshBtn.style.opacity = '0.6';
                refreshBtn.style.pointerEvents = 'none';
                speechBtn.style.opacity = '0.6';
                speechBtn.style.pointerEvents = 'none';
                
                try {
                    // Get page count
                    const pageCount = parseInt(pageCountSelect.value, 10);
                    
                    // Generate story content
                    loadingText.textContent = '正在生成故事内容...';
                    const story = await generateStoryContent(currentTopic, pageCount);
                    
                    // Generate images for each page
                    loadingText.textContent = '正在为故事生成插图...';
                    storyPages = await generateImagesForStory(story);
                    
                    // Display the story
                    displayStory();
                    
                    // Enable controls
                    refreshBtn.style.opacity = '1';
                    refreshBtn.style.pointerEvents = 'auto';
                    speechBtn.style.opacity = '1';
                    speechBtn.style.pointerEvents = 'auto';
                    
                    // Start reading automatically
                    setTimeout(() => {
                        startReading();
                        speechBtn.innerHTML = '<i class="fas fa-volume-mute"></i>';
                        speechBtn.title = '暂停朗读';
                    }, 500);
                } catch (error) {
                    console.error('Story generation error:', error);
                    showFeedback('生成故事失败，请重试', 'fa-exclamation-circle');
                    
                    setTimeout(() => {
                        feedbackOverlay.style.display = 'none';
                        emptyPrompt.style.display = 'flex';
                    }, 2000);
                } finally {
                    isGenerating = false;
                    loadingAnimation.style.display = 'none';
                    
                    // Re-enable voice and generate buttons
                    voiceBtn.style.opacity = '1';
                    voiceBtn.style.pointerEvents = 'auto';
                    generateBtn.style.opacity = '1';
                    generateBtn.style.pointerEvents = 'auto';
                }
            }
            
            // Generate story content using API
            async function generateStoryContent(topic, pageCount) {
                const apiUrl = useGlmApi ? GLM_API_URL : ZETATECHS_API_URL;
                const apiKey = useGlmApi ? GLM_API_KEY : ZETATECHS_API_KEY;
                const model = useGlmApi ? 'glm-4' : 'gpt-4o';
                
                const prompt = `为${pageCount}岁的儿童创作一个有关"${topic}"的绘本故事，分为${pageCount}页，每页不超过20字。响应格式为JSON，包含title字段和pages数组，pages数组中每个元素包含text字段(页面文本)和description字段(用于生成插图的详细描述)。`;
                
                try {
                    const response = await fetch(`${apiUrl}/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
                            model: model,
            messages: [
              { role: 'system', content: '你是专业的儿童绘本创作者，擅长创作适合幼儿的简短故事。' },
              { role: 'user', content: prompt }
            ],
            temperature: 0.7,
            response_format: { type: 'json_object' }
          })
        });
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error?.message || '生成故事失败');
        }
        
        const data = await response.json();
        const content = data.choices[0].message.content;
        
        try {
          return JSON.parse(content);
        } catch (e) {
          throw new Error('返回的数据格式不正确');
        }
                } catch (error) {
                    console.error('API call failed:', error);
                    throw error;
                }
            }
            
            // Generate images for story
            async function generateImagesForStory(story) {
                const apiUrl = useGlmApi ? GLM_API_URL : ZETATECHS_API_URL;
                const apiKey = useGlmApi ? GLM_API_KEY : ZETATECHS_API_KEY;
                const model = useGlmApi ? 'cogview-3' : 'dall-e-3';
                
                const imagePromises = story.pages.map(async (page, index) => {
                    loadingText.textContent = `正在生成第 ${index + 1}/${story.pages.length} 页的插图...`;
                    
                    const prompt = `为儿童绘本创作一张插图，内容: ${page.description || page.text}。画风可爱、色彩鲜艳，适合幼儿。`;
                    
                    try {
                        const response = await fetch(`${apiUrl}/images/generations`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                                model: model,
                                prompt: prompt,
                  n: 1,
                  size: '1024x1024'
                })
              });
              
              if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || '生成图像失败');
              }
              
              const data = await response.json();
                        return {
                            text: page.text,
                            imageUrl: data.data[0].url
                        };
            } catch (error) {
                        console.error('Image generation failed:', error);
                        
                        // Fallback to a placeholder image
          return {
            text: page.text,
                            imageUrl: 'https://via.placeholder.com/512x512?text=生成失败'
                        };
                    }
                });
                
                const pages = await Promise.all(imagePromises);
      
      return {
        title: story.title,
                    pages: pages
                };
            }
            
            // Display story function
            function displayStory() {
                if (!storyPages || !storyPages.pages || storyPages.pages.length === 0) {
                    return;
                }
                
                // Update story title
                storyTitle.textContent = storyPages.title;
                
                // Show story content
                storyContent.style.display = 'flex';
                
                // Reset to first page
          currentPage = 0;
          showPage(currentPage);
          
          // 保存故事到localStorage，以便知识库自动保存
          localStorage.setItem('lastGeneratedStory', JSON.stringify(storyPages));
    }
    
            // Show specific page
    function showPage(pageIndex) {
                if (!storyPages || pageIndex < 0 || pageIndex >= storyPages.pages.length) {
        return;
      }
      
      const page = storyPages.pages[pageIndex];
      
                // Update page image
        pageImage.src = page.imageUrl;
                
                // Wrap each character in a span for highlighting
                const text = page.text;
                let wrappedText = '';
                for (let i = 0; i < text.length; i++) {
                    wrappedText += `<span class="character-span" data-index="${i}">${text[i]}</span>`;
                }
                pageText.innerHTML = wrappedText;
                
                // Update page indicator
                pageIndicator.textContent = `${pageIndex + 1} / ${storyPages.pages.length}`;
                
                // Update current page index
      currentPage = pageIndex;
    }
    
            // Start reading story
            function startReading() {
                if (!storyPages || !storyPages.pages || storyPages.pages.length === 0) {
                    return;
                }
                
                isReading = true;
          speakCurrentPage();
        }
            
            // Stop reading story
            function stopReading(resetReadingFlag = true) {
                if (resetReadingFlag) {
                    isReading = false;
                }
                
                // 标记用户停止朗读，中断逐字朗读循环
                window.userStoppedReading = true;
                
                // 取消所有排队的语音
                window.speechSynthesis.cancel();
                
                if (window.highlightInterval) {
                    clearInterval(window.highlightInterval);
                    window.highlightInterval = null;
                }
                
                // Reset all character highlights
                const charSpans = document.querySelectorAll('.character-span');
                charSpans.forEach(span => {
                    span.classList.remove('active');
                });
            }
            
            // Speak current page
    function speakCurrentPage() {
                if (!storyPages || !storyPages.pages[currentPage]) {
        return;
      }
      
                // Cancel any ongoing speech and clear any existing intervals
                stopReading(false); // Stop but don't reset isReading flag
                
                const text = storyPages.pages[currentPage].text;
                const charSpans = document.querySelectorAll('.character-span');
                
                // Reset all highlights
                charSpans.forEach(span => {
                    span.classList.remove('active');
                });
                
                // 将文本按句子分割（根据标点符号）
                const sentences = text.split(/([。！？\.!?]+)/).map((part, i, arr) => {
                    // 将标点符号附加到前一部分，形成完整句子
                    if (i % 2 === 1 && i < arr.length - 1) {
                        return part + arr[i + 1];
                    } else if (i % 2 === 0 && i > 0) {
                        return ''; // 标点符号已被附加到前一部分
                    }
                    return part;
                }).filter(s => s.trim().length > 0);
                
                // 如果没有分割出句子（可能是很短的文本），就将整个文本作为一个句子
                if (sentences.length === 0) {
                    sentences.push(text);
                }
                
                // 标记用户是否停止朗读，用于中断朗读循环
                window.userStoppedReading = false;
                
                // 使用async函数进行逐句朗读
                (async function readSentenceBySebtence() {
                    // 逐句朗读
                    for (let i = 0; i < sentences.length; i++) {
                        // 如果用户停止朗读，中断循环
                        if (window.userStoppedReading || !isReading) {
                            break;
                        }
                        
                        // 找出当前句子中字符的起始和结束位置
                        const sentence = sentences[i];
                        const sentenceStartPos = text.indexOf(sentence);
                        const sentenceEndPos = sentenceStartPos + sentence.length - 1;
                        
                        // 计算句子中每个字符的读音时间
                        const charTime = (1000 / 1.0) / 3; // 使用固定的正常速度1.0
                        const totalSpeakTime = sentence.length * charTime;
                        
                        // 开始朗读当前句子
                        const speakPromise = new Promise(resolve => {
                            const utterance = new SpeechSynthesisUtterance(sentence);
                            utterance.lang = 'zh-CN';
                            
                            // 使用固定的正常速度
                            utterance.rate = 1.0;
                            
                            // 获取中文语音
                            const voices = window.speechSynthesis.getVoices();
                            const chineseVoice = voices.find(voice => voice.lang.includes('zh'));
                            if (chineseVoice) {
                                utterance.voice = chineseVoice;
                            }
                            
                            utterance.onend = resolve;
                            utterance.onerror = resolve; // 即使出错也继续
                            
                            window.speechSynthesis.speak(utterance);
                        });
                        
                        // 同时随着朗读逐字高亮
                        const highlightPromise = new Promise(async resolve => {
                            // 先清除所有高亮
                            charSpans.forEach(span => span.classList.remove('active'));
                            
                            // 计算当前句子中的每个字符
                            for (let j = 0; j <= sentenceEndPos - sentenceStartPos; j++) {
                                // 如果用户停止朗读，中断循环
                                if (window.userStoppedReading || !isReading) {
                                    break;
                                }
                                
                                const currentCharIndex = sentenceStartPos + j;
                                
                                // 高亮当前字符
                                charSpans.forEach(span => {
                                    const charIndex = parseInt(span.getAttribute('data-index'));
                                    if (charIndex === currentCharIndex) {
                                        span.classList.add('active');
                                    } else {
                                        span.classList.remove('active');
                                    }
                                });
                                
                                // 等待一段时间，模拟朗读进度
                                await new Promise(r => setTimeout(r, charTime));
                            }
                            resolve();
                        });
                        
                        // 等待朗读和高亮都完成
                        await Promise.all([speakPromise, highlightPromise]);
                        
                        // 句子之间添加短暂停顿
                        if (i < sentences.length - 1) {
                            const speedFactor = 1 / 1.0;  // 使用固定的正常速度
                            const pauseTime = 300 * speedFactor; // 句子间停顿
                            await new Promise(resolve => setTimeout(resolve, pauseTime));
                        }
                    }
                    
                    // 完成当前页面朗读
                    if (!window.userStoppedReading && isReading) {
                        // 检查是否需要翻到下一页
                        if (currentPage < storyPages.pages.length - 1) {
                            // 在短暂延迟后自动前往下一页
                            setTimeout(() => {
                                showPage(currentPage + 1);
                                speakCurrentPage();
                            }, 1000);
                        } else {
                            // 到达故事结尾
                            isReading = false;
                            speechBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
                            speechBtn.title = '朗读故事';
                        }
                    }
                })();
            }
            
            // Show feedback overlay
            function showFeedback(message, iconClass) {
                feedbackIcon.className = `fas ${iconClass} feedback-icon`;
                feedbackText.innerHTML = message;
                
                // 添加关闭按钮到反馈框
                if (!document.getElementById('closeFeedbackBtn')) {
                    const closeBtn = document.createElement('div');
                    closeBtn.id = 'closeFeedbackBtn';
                    closeBtn.style.marginTop = '15px';
                    closeBtn.style.padding = '8px 15px';
                    closeBtn.style.backgroundColor = '#f0f0f0';
                    closeBtn.style.borderRadius = '20px';
                    closeBtn.style.cursor = 'pointer';
                    closeBtn.style.display = 'inline-block';
                    closeBtn.innerHTML = '完成输入';
                    closeBtn.onclick = function() {
                        if (isListening) {
                            isListening = false;
                            recognition.stop();
                            voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                            voiceBtn.title = '说出故事主题';
                            voiceBtn.style.boxShadow = '';
                        }
                        feedbackOverlay.style.display = 'none';
                        
                        // 如果有主题，开始生成故事
                        if (currentTopic.trim().length > 0 && !isGenerating) {
                            generateStory();
                        }
                    };
                    feedbackText.parentNode.appendChild(closeBtn);
                }
                
                feedbackOverlay.style.display = 'flex';
            }
            
            // Initialize speech synthesis
            initSpeechSynthesis();
            
            // Chrome needs this extra event for voice loading
            if (window.speechSynthesis) {
                window.speechSynthesis.onvoiceschanged = function() {
                    window.speechSynthesis.getVoices();
                };
            }
        });
  </script>
</body>
</html> 